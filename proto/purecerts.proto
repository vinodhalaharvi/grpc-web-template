syntax = "proto3";

package purecerts.v1;

option go_package = "github.com/vinodhalaharvi/grpc-web-template/gen/go/purecerts/v1;purecertsv1";

import "buf/validate/validate.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "options/v1/options.proto";

// =============================================================================
// COMMON TYPES
// =============================================================================

message Pagination {
  int32 page = 1 [(buf.validate.field).int32.gte = 1];
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
  int32 total = 3;
  int32 total_pages = 4;
}

message Subject {
  string common_name = 1 [(buf.validate.field).string.max_len = 255];
  string organization = 2 [(buf.validate.field).string.max_len = 255];
  string organizational_unit = 3 [(buf.validate.field).string.max_len = 255];
  string country = 4 [(buf.validate.field).string = {min_len: 0, max_len: 2}];
  string state = 5 [(buf.validate.field).string.max_len = 255];
  string locality = 6 [(buf.validate.field).string.max_len = 255];
}

message Metadata {
  map<string, string> labels = 1;
}

enum KeyAlgorithm {
  KEY_ALGORITHM_UNSPECIFIED = 0;
  KEY_ALGORITHM_RSA = 1;
  KEY_ALGORITHM_ECDSA = 2;
  KEY_ALGORITHM_ED25519 = 3;
}

enum CertificateStatus {
  CERTIFICATE_STATUS_UNSPECIFIED = 0;
  CERTIFICATE_STATUS_ACTIVE = 1;
  CERTIFICATE_STATUS_EXPIRING = 2;
  CERTIFICATE_STATUS_EXPIRED = 3;
  CERTIFICATE_STATUS_REVOKED = 4;
}

enum RevocationReason {
  REVOCATION_REASON_UNSPECIFIED = 0;
  REVOCATION_REASON_KEY_COMPROMISE = 1;
  REVOCATION_REASON_CA_COMPROMISE = 2;
  REVOCATION_REASON_AFFILIATION_CHANGED = 3;
  REVOCATION_REASON_SUPERSEDED = 4;
  REVOCATION_REASON_CESSATION_OF_OPERATION = 5;
  REVOCATION_REASON_CERTIFICATE_HOLD = 6;
  REVOCATION_REASON_REMOVE_FROM_CRL = 7;
  REVOCATION_REASON_PRIVILEGE_WITHDRAWN = 8;
  REVOCATION_REASON_AA_COMPROMISE = 9;
}

enum DownloadFormat {
  DOWNLOAD_FORMAT_UNSPECIFIED = 0;
  DOWNLOAD_FORMAT_PEM = 1;
  DOWNLOAD_FORMAT_DER = 2;
  DOWNLOAD_FORMAT_PKCS12 = 3;
  DOWNLOAD_FORMAT_PKCS7 = 4;
}

enum Role {
  ROLE_UNSPECIFIED = 0;
  ROLE_ADMIN = 1;
  ROLE_OPERATOR = 2;
  ROLE_VIEWER = 3;
}

// =============================================================================
// TOKEN SERVICE (OAuth2/JWT Standard)
// =============================================================================

service TokenService {
  // Create token (login) - OAuth2 token endpoint
  rpc CreateToken(CreateTokenRequest) returns (TokenResponse);

  // Refresh token - OAuth2 refresh
  rpc RefreshToken(RefreshTokenRequest) returns (TokenResponse);

  // Revoke token - OAuth2 revocation
  rpc RevokeToken(RevokeTokenRequest) returns (google.protobuf.Empty);

  // Introspect token - OAuth2 introspection (RFC 7662)
  rpc IntrospectToken(IntrospectTokenRequest) returns (IntrospectTokenResponse);
}

// OAuth2 grant types
enum GrantType {
  GRANT_TYPE_UNSPECIFIED = 0;
  GRANT_TYPE_PASSWORD = 1;          // Resource owner password
  GRANT_TYPE_REFRESH_TOKEN = 2;     // Refresh token
  GRANT_TYPE_CLIENT_CREDENTIALS = 3; // Service-to-service
}

message CreateTokenRequest {
  GrantType grant_type = 1 [(buf.validate.field).enum.defined_only = true];

  // For password grant
  string username = 2 [(buf.validate.field).string.email = true];
  string password = 3 [(buf.validate.field).string = {min_len: 8, max_len: 128}];

  // For client credentials
  string client_id = 4;
  string client_secret = 5;

  // Optional scope
  string scope = 6;
}

message RefreshTokenRequest {
  string refresh_token = 1 [(buf.validate.field).string.min_len = 1];
}

message RevokeTokenRequest {
  string token = 1 [(buf.validate.field).string.min_len = 1];
  string token_type_hint = 2; // "access_token" or "refresh_token"
}

message IntrospectTokenRequest {
  string token = 1 [(buf.validate.field).string.min_len = 1];
  string token_type_hint = 2;
}

// OAuth2 Token Response (RFC 6749)
message TokenResponse {
  string access_token = 1;
  string token_type = 2;      // Always "Bearer"
  int64 expires_in = 3;       // Seconds until expiration
  string refresh_token = 4;
  string scope = 5;

  // Extended: Include user info (common practice)
  User user = 6;

  // 2FA: If set, user must call Verify2FA before accessing resources
  string mfa_token = 7;       // Temporary token for 2FA verification
  bool mfa_required = 8;      // True if 2FA is required
}

// OAuth2 Introspection Response (RFC 7662)
message IntrospectTokenResponse {
  bool active = 1;
  string scope = 2;
  string client_id = 3;
  string username = 4;
  string token_type = 5;
  int64 exp = 6;              // Expiration timestamp
  int64 iat = 7;              // Issued at timestamp
  int64 nbf = 8;              // Not before timestamp
  string sub = 9;             // Subject (user_id)
  string aud = 10;            // Audience
  string iss = 11;            // Issuer
  string jti = 12;            // JWT ID

  // Extended
  string tenant_id = 13;
  Role role = 14;
}

// =============================================================================
// USER SERVICE
// =============================================================================

service UserService {
  // Register new user
  rpc CreateUser(CreateUserRequest) returns (User);

  // Get current user (from token)
  rpc GetCurrentUser(google.protobuf.Empty) returns (User);

  // Get user by ID (admin only)
  rpc GetUser(GetUserRequest) returns (User);

  // Update user
  rpc UpdateUser(UpdateUserRequest) returns (User);

  // Delete user
  rpc DeleteUser(DeleteUserRequest) returns (google.protobuf.Empty);

  // List users in tenant
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);

  // Change password
  rpc ChangePassword(ChangePasswordRequest) returns (google.protobuf.Empty);

  // Request password reset
  rpc RequestPasswordReset(RequestPasswordResetRequest) returns (google.protobuf.Empty);

  // Reset password with token
  rpc ResetPassword(ResetPasswordRequest) returns (google.protobuf.Empty);

  // ---------- Email Verification ----------

  // Verify email with token (from email link)
  rpc VerifyEmail(VerifyEmailRequest) returns (google.protobuf.Empty);

  // Resend verification email
  rpc ResendVerificationEmail(google.protobuf.Empty) returns (google.protobuf.Empty);

  // ---------- Invite Flow ----------

  // Invite user to tenant (admin only)
  rpc InviteUser(InviteUserRequest) returns (Invite);

  // List pending invites
  rpc ListInvites(ListInvitesRequest) returns (ListInvitesResponse);

  // Cancel invite
  rpc CancelInvite(CancelInviteRequest) returns (google.protobuf.Empty);

  // Accept invite (creates user account)
  rpc AcceptInvite(AcceptInviteRequest) returns (User);

  // ---------- 2FA / MFA ----------

  // Enable 2FA - returns secret + QR code
  rpc Enable2FA(google.protobuf.Empty) returns (Enable2FAResponse);

  // Confirm 2FA setup with TOTP code
  rpc Confirm2FA(Confirm2FARequest) returns (Confirm2FAResponse);

  // Disable 2FA
  rpc Disable2FA(Disable2FARequest) returns (google.protobuf.Empty);

  // Verify 2FA during login
  rpc Verify2FA(Verify2FARequest) returns (TokenResponse);

  // Get 2FA status
  rpc Get2FAStatus(google.protobuf.Empty) returns (TwoFactorStatus);

  // Regenerate backup codes
  rpc RegenerateBackupCodes(RegenerateBackupCodesRequest) returns (BackupCodesResponse);
}

// ---------- Email Verification Messages ----------

message VerifyEmailRequest {
  string token = 1 [(buf.validate.field).string.min_len = 1];
}

// ---------- Invite Messages ----------

message Invite {
  option (bufplugins.options.v1.entity) = {
    collection: "invites"
    id_field: "invite_id"
  };

  string invite_id = 1;
  string tenant_id = 2;
  string email = 3;
  Role role = 4;
  string invited_by = 5;
  InviteStatus status = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp expires_at = 8;
}

enum InviteStatus {
  INVITE_STATUS_UNSPECIFIED = 0;
  INVITE_STATUS_PENDING = 1;
  INVITE_STATUS_ACCEPTED = 2;
  INVITE_STATUS_EXPIRED = 3;
  INVITE_STATUS_CANCELED = 4;
}

message InviteUserRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  Role role = 2 [(buf.validate.field).enum.defined_only = true];
}

message ListInvitesRequest {
  int32 page = 1;
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
  optional InviteStatus status = 3;
}

message ListInvitesResponse {
  repeated Invite invites = 1;
  Pagination pagination = 2;
}

message CancelInviteRequest {
  string invite_id = 1 [(buf.validate.field).string.min_len = 1];
}

message AcceptInviteRequest {
  string token = 1 [(buf.validate.field).string.min_len = 1];
  string password = 2 [(buf.validate.field).string = {min_len: 8, max_len: 128}];
  string first_name = 3 [(buf.validate.field).string = {min_len: 1, max_len: 50}];
  string last_name = 4 [(buf.validate.field).string = {min_len: 1, max_len: 50}];
}

// ---------- 2FA Messages ----------

message Enable2FAResponse {
  string secret = 1;           // Base32 encoded TOTP secret
  string qr_code_uri = 2;      // otpauth:// URI for QR code
  string qr_code_base64 = 3;   // QR code image as base64 PNG
}

message Confirm2FARequest {
  string code = 1 [(buf.validate.field).string = {min_len: 6, max_len: 6}];
}

message Confirm2FAResponse {
  repeated string backup_codes = 1;  // One-time backup codes
}

message Disable2FARequest {
  string code = 1 [(buf.validate.field).string = {min_len: 6, max_len: 6}];  // Current TOTP or backup code
}

message Verify2FARequest {
  string code = 1 [(buf.validate.field).string = {min_len: 6, max_len: 8}];  // TOTP or backup code
  string mfa_token = 2 [(buf.validate.field).string.min_len = 1];  // Temporary token from login
}

message TwoFactorStatus {
  bool enabled = 1;
  google.protobuf.Timestamp enabled_at = 2;
  int32 backup_codes_remaining = 3;
}

message RegenerateBackupCodesRequest {
  string code = 1 [(buf.validate.field).string = {min_len: 6, max_len: 6}];  // Current TOTP code
}

message BackupCodesResponse {
  repeated string backup_codes = 1;
}

message User {
  option (bufplugins.options.v1.entity) = {
    collection: "users"
    id_field: "user_id"
  };

  string user_id = 1;
  string tenant_id = 2;
  string email = 3;
  string first_name = 4;
  string last_name = 5;
  Role role = 6;
  bool email_verified = 7;
  bool active = 8;
  bool two_factor_enabled = 9;
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
  google.protobuf.Timestamp last_login_at = 12;
}

message CreateUserRequest {
  string email = 1 [(buf.validate.field).string.email = true];
  string password = 2 [(buf.validate.field).string = {min_len: 8, max_len: 128}];
  string first_name = 3 [(buf.validate.field).string = {min_len: 1, max_len: 50}];
  string last_name = 4 [(buf.validate.field).string = {min_len: 1, max_len: 50}];
  string company = 5 [(buf.validate.field).string.max_len = 100];
}

message GetUserRequest {
  string user_id = 1 [(buf.validate.field).string.min_len = 1];
}

message UpdateUserRequest {
  string user_id = 1 [(buf.validate.field).string.min_len = 1];
  optional string first_name = 2 [(buf.validate.field).string.max_len = 50];
  optional string last_name = 3 [(buf.validate.field).string.max_len = 50];
  optional Role role = 4;
  optional bool active = 5;
}

message DeleteUserRequest {
  string user_id = 1 [(buf.validate.field).string.min_len = 1];
}

message ListUsersRequest {
  int32 page = 1 [(buf.validate.field).int32.gte = 0];
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
  optional Role role = 3;
  optional bool active = 4;
}

message ListUsersResponse {
  repeated User users = 1;
  Pagination pagination = 2;
}

message ChangePasswordRequest {
  string current_password = 1 [(buf.validate.field).string.min_len = 1];
  string new_password = 2 [(buf.validate.field).string = {min_len: 8, max_len: 128}];
}

message RequestPasswordResetRequest {
  string email = 1 [(buf.validate.field).string.email = true];
}

message ResetPasswordRequest {
  string token = 1 [(buf.validate.field).string.min_len = 1];
  string new_password = 2 [(buf.validate.field).string = {min_len: 8, max_len: 128}];
}

// =============================================================================
// TENANT SERVICE
// =============================================================================

service TenantService {
  rpc GetTenant(GetTenantRequest) returns (Tenant);
  rpc UpdateTenant(UpdateTenantRequest) returns (Tenant);
  rpc GetTenantStats(GetTenantRequest) returns (TenantStats);
}

message Tenant {
  option (bufplugins.options.v1.entity) = {
    collection: "tenants"
    id_field: "tenant_id"
  };

  string tenant_id = 1;
  string name = 2;
  TenantSettings settings = 3;
  TenantLimits limits = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp updated_at = 6;
}

message TenantSettings {
  string default_ca_id = 1;
  int32 default_validity_days = 2;
  bool auto_renewal_enabled = 3;
  int32 expiry_warning_days = 4;
  string notification_email = 5;
}

message TenantLimits {
  int32 max_certificates = 1;
  int32 max_cas = 2;
  int32 max_users = 3;
}

message TenantStats {
  int32 total_certificates = 1;
  int32 active_certificates = 2;
  int32 expiring_certificates = 3;
  int32 expired_certificates = 4;
  int32 revoked_certificates = 5;
  int32 total_cas = 6;
  int32 total_users = 7;
}

message GetTenantRequest {
  string tenant_id = 1;
}

message UpdateTenantRequest {
  string tenant_id = 1;
  optional string name = 2 [(buf.validate.field).string.max_len = 100];
  optional TenantSettings settings = 3;
}

// =============================================================================
// CERTIFICATE SERVICE
// =============================================================================

service CertificateService {
  rpc ListCertificates(ListCertificatesRequest) returns (ListCertificatesResponse);
  rpc GetCertificate(GetCertificateRequest) returns (Certificate);
  rpc IssueCertificate(IssueCertificateRequest) returns (Certificate);
  rpc GenerateCertificate(GenerateCertificateRequest) returns (CertificateWithKey);
  rpc RenewCertificate(RenewCertificateRequest) returns (Certificate);
  rpc RevokeCertificate(RevokeCertificateRequest) returns (Certificate);
  rpc DeleteCertificate(DeleteCertificateRequest) returns (google.protobuf.Empty);
  rpc DownloadCertificate(DownloadCertificateRequest) returns (DownloadCertificateResponse);
  rpc UpdateCertificateTags(UpdateCertificateTagsRequest) returns (Certificate);
  rpc UpdateCertificateMetadata(UpdateCertificateMetadataRequest) returns (Certificate);
  rpc ValidateCertificate(ValidateCertificateRequest) returns (ValidateCertificateResponse);
}

message Certificate {
  option (bufplugins.options.v1.entity) = {
    collection: "certificates"
    id_field: "cert_id"
  };

  string cert_id = 1;
  string common_name = 2;
  string serial_number = 3;
  string issuer_cn = 4;
  string ca_id = 5;
  CertificateStatus status = 6;
  google.protobuf.Timestamp not_before = 7;
  google.protobuf.Timestamp not_after = 8;
  int32 days_remaining = 9;
  Subject subject = 10;
  repeated string san = 11;
  KeyAlgorithm key_algorithm = 12;
  int32 key_size = 13;
  string signature_algorithm = 14;
  repeated string tags = 15;
  Metadata metadata = 16;
  google.protobuf.Timestamp created_at = 17;
  string created_by = 18;
  google.protobuf.Timestamp updated_at = 19;
  Revocation revocation = 20;
  string fingerprint_sha256 = 21;
}

message CertificateWithKey {
  Certificate certificate = 1;
  string private_key_pem = 2;
}

message Revocation {
  google.protobuf.Timestamp revoked_at = 1;
  RevocationReason reason = 2;
  string revoked_by = 3;
  string comment = 4;
}

message CertificateSummary {
  int32 total = 1;
  int32 active = 2;
  int32 expiring = 3;
  int32 expired = 4;
  int32 revoked = 5;
}

message ListCertificatesRequest {
  int32 page = 1 [(buf.validate.field).int32.gte = 0];
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
  optional CertificateStatus status = 3;
  optional string search = 4 [(buf.validate.field).string.max_len = 255];
  repeated string tags = 5 [(buf.validate.field).repeated.max_items = 10];
  optional string ca_id = 6;
  optional string sort_by = 7;
  optional bool sort_desc = 8;
}

message ListCertificatesResponse {
  repeated Certificate certificates = 1;
  Pagination pagination = 2;
  CertificateSummary summary = 3;
}

message GetCertificateRequest {
  string cert_id = 1 [(buf.validate.field).string.min_len = 1];
}

message IssueCertificateRequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
  string csr = 2 [(buf.validate.field).string.min_len = 100];
  int32 validity_days = 3 [(buf.validate.field).int32 = {gte: 1, lte: 825}];
  repeated string tags = 4 [(buf.validate.field).repeated.max_items = 20];
  Metadata metadata = 5;
}

message GenerateCertificateRequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
  Subject subject = 2 [(buf.validate.field).required = true];
  repeated string san = 3 [(buf.validate.field).repeated.max_items = 100];
  KeyAlgorithm key_algorithm = 4 [(buf.validate.field).enum.defined_only = true];
  int32 key_size = 5 [(buf.validate.field).int32 = {gte: 256, lte: 8192}];
  int32 validity_days = 6 [(buf.validate.field).int32 = {gte: 1, lte: 825}];
  repeated string tags = 7 [(buf.validate.field).repeated.max_items = 20];
  Metadata metadata = 8;
}

message RenewCertificateRequest {
  string cert_id = 1 [(buf.validate.field).string.min_len = 1];
  optional int32 validity_days = 2 [(buf.validate.field).int32 = {gte: 1, lte: 825}];
  bool keep_private_key = 3;
}

message RevokeCertificateRequest {
  string cert_id = 1 [(buf.validate.field).string.min_len = 1];
  RevocationReason reason = 2 [(buf.validate.field).enum.defined_only = true];
  string comment = 3 [(buf.validate.field).string.max_len = 500];
}

message DeleteCertificateRequest {
  string cert_id = 1 [(buf.validate.field).string.min_len = 1];
}

message DownloadCertificateRequest {
  string cert_id = 1 [(buf.validate.field).string.min_len = 1];
  DownloadFormat format = 2;
  bool include_chain = 3;
  string password = 4 [(buf.validate.field).string.max_len = 128]; // For PKCS12
}

message DownloadCertificateResponse {
  bytes data = 1;
  string filename = 2;
  string content_type = 3;
}

message UpdateCertificateTagsRequest {
  string cert_id = 1 [(buf.validate.field).string.min_len = 1];
  repeated string tags = 2 [(buf.validate.field).repeated.max_items = 20];
}

message UpdateCertificateMetadataRequest {
  string cert_id = 1 [(buf.validate.field).string.min_len = 1];
  Metadata metadata = 2;
}

message ValidateCertificateRequest {
  string certificate_pem = 1 [(buf.validate.field).string.min_len = 100];
  bool check_revocation = 2;
}

message ValidateCertificateResponse {
  bool valid = 1;
  repeated string errors = 2;
  repeated string warnings = 3;
  Certificate certificate = 4;
}

// =============================================================================
// CA SERVICE
// =============================================================================

service CAService {
  rpc ListCAs(ListCAsRequest) returns (ListCAsResponse);
  rpc GetCA(GetCARequest) returns (CA);
  rpc CreateCA(CreateCARequest) returns (CA);
  rpc CreateIntermediateCA(CreateIntermediateCARequest) returns (CA);
  rpc ImportCA(ImportCARequest) returns (CA);
  rpc UpdateCA(UpdateCARequest) returns (CA);
  rpc DeleteCA(DeleteCARequest) returns (google.protobuf.Empty);
  rpc GetCAChain(GetCAChainRequest) returns (GetCAChainResponse);
  rpc DownloadCA(DownloadCARequest) returns (DownloadCAResponse);
  rpc GetCRL(GetCRLRequest) returns (GetCRLResponse);
  rpc GenerateCRL(GenerateCRLRequest) returns (GetCRLResponse);
}

message CA {
  option (bufplugins.options.v1.entity) = {
    collection: "cas"
    id_field: "ca_id"
  };

  string ca_id = 1;
  string name = 2;
  CAType type = 3;
  string parent_ca_id = 4;
  CAStatus status = 5;
  Subject subject = 6;
  KeyAlgorithm key_algorithm = 7;
  int32 key_size = 8;
  string signature_algorithm = 9;
  google.protobuf.Timestamp not_before = 10;
  google.protobuf.Timestamp not_after = 11;
  string serial_number = 12;
  string fingerprint_sha256 = 13;
  CAStats stats = 14;
  CAPolicies policies = 15;
  google.protobuf.Timestamp created_at = 16;
  google.protobuf.Timestamp updated_at = 17;
}

enum CAType {
  CA_TYPE_UNSPECIFIED = 0;
  CA_TYPE_ROOT = 1;
  CA_TYPE_INTERMEDIATE = 2;
}

enum CAStatus {
  CA_STATUS_UNSPECIFIED = 0;
  CA_STATUS_ACTIVE = 1;
  CA_STATUS_INACTIVE = 2;
  CA_STATUS_PENDING = 3;
}

message CAStats {
  int32 certificates_issued = 1;
  int32 certificates_active = 2;
  int32 certificates_revoked = 3;
  int32 certificates_expired = 4;
}

message CAPolicies {
  int32 default_validity_days = 1;
  int32 max_validity_days = 2;
  repeated KeyAlgorithm allowed_key_algorithms = 3;
  int32 min_rsa_key_size = 4;
  repeated string allowed_ec_curves = 5;
  bool require_san = 6;
  bool allow_wildcard = 7;
  repeated string allowed_domains = 8;
}

message ListCAsRequest {
  int32 page = 1;
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
  optional CAStatus status = 3;
  optional CAType type = 4;
}

message ListCAsResponse {
  repeated CA cas = 1;
  Pagination pagination = 2;
}

message GetCARequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
}

message CreateCARequest {
  string name = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  Subject subject = 2 [(buf.validate.field).required = true];
  KeyAlgorithm key_algorithm = 3 [(buf.validate.field).enum.defined_only = true];
  int32 key_size = 4 [(buf.validate.field).int32 = {gte: 2048, lte: 8192}];
  string signature_algorithm = 5;
  int32 validity_years = 6 [(buf.validate.field).int32 = {gte: 1, lte: 30}];
  CAPolicies policies = 7;
}

message CreateIntermediateCARequest {
  string parent_ca_id = 1 [(buf.validate.field).string.min_len = 1];
  string name = 2 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  Subject subject = 3 [(buf.validate.field).required = true];
  KeyAlgorithm key_algorithm = 4;
  int32 key_size = 5 [(buf.validate.field).int32 = {gte: 2048, lte: 8192}];
  int32 validity_years = 6 [(buf.validate.field).int32 = {gte: 1, lte: 20}];
  int32 path_length = 7 [(buf.validate.field).int32 = {gte: 0, lte: 5}];
  CAPolicies policies = 8;
}

message ImportCARequest {
  string name = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  string certificate_pem = 2 [(buf.validate.field).string.min_len = 100];
  string private_key_pem = 3 [(buf.validate.field).string.min_len = 100];
  string private_key_password = 4;
  optional string parent_ca_id = 5;
}

message UpdateCARequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
  optional string name = 2 [(buf.validate.field).string.max_len = 100];
  optional CAStatus status = 3;
  optional CAPolicies policies = 4;
}

message DeleteCARequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
  bool force = 2; // Delete even if certificates exist
}

message GetCAChainRequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
}

message GetCAChainResponse {
  repeated string certificates_pem = 1;
}

message DownloadCARequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
  CADownloadType type = 2;
}

enum CADownloadType {
  CA_DOWNLOAD_TYPE_UNSPECIFIED = 0;
  CA_DOWNLOAD_TYPE_CERTIFICATE = 1;
  CA_DOWNLOAD_TYPE_PRIVATE_KEY = 2;
  CA_DOWNLOAD_TYPE_CHAIN = 3;
  CA_DOWNLOAD_TYPE_BUNDLE = 4;
}

message DownloadCAResponse {
  bytes data = 1;
  string filename = 2;
  string content_type = 3;
}

message GetCRLRequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
}

message GenerateCRLRequest {
  string ca_id = 1 [(buf.validate.field).string.min_len = 1];
}

message GetCRLResponse {
  bytes crl_der = 1;
  string crl_pem = 2;
  google.protobuf.Timestamp this_update = 3;
  google.protobuf.Timestamp next_update = 4;
  int32 revoked_count = 5;
}

// =============================================================================
// AUDIT SERVICE
// =============================================================================

service AuditService {
  rpc ListAuditLogs(ListAuditLogsRequest) returns (ListAuditLogsResponse);
  rpc GetAuditLog(GetAuditLogRequest) returns (AuditLog);
}

message AuditLog {
  option (bufplugins.options.v1.entity) = {
    collection: "audit_logs"
    id_field: "log_id"
  };

  string log_id = 1;
  string tenant_id = 2;
  string user_id = 3;
  string user_email = 4;
  AuditAction action = 5;
  string resource_type = 6;
  string resource_id = 7;
  map<string, string> details = 8;
  string ip_address = 9;
  string user_agent = 10;
  google.protobuf.Timestamp timestamp = 11;
}

enum AuditAction {
  AUDIT_ACTION_UNSPECIFIED = 0;
  // User actions
  AUDIT_ACTION_USER_LOGIN = 1;
  AUDIT_ACTION_USER_LOGOUT = 2;
  AUDIT_ACTION_USER_CREATED = 3;
  AUDIT_ACTION_USER_UPDATED = 4;
  AUDIT_ACTION_USER_DELETED = 5;
  AUDIT_ACTION_USER_INVITED = 6;
  AUDIT_ACTION_USER_INVITE_ACCEPTED = 7;
  AUDIT_ACTION_PASSWORD_CHANGED = 8;
  AUDIT_ACTION_PASSWORD_RESET = 9;
  // 2FA actions
  AUDIT_ACTION_2FA_ENABLED = 15;
  AUDIT_ACTION_2FA_DISABLED = 16;
  // Certificate actions
  AUDIT_ACTION_CERTIFICATE_ISSUED = 20;
  AUDIT_ACTION_CERTIFICATE_GENERATED = 21;
  AUDIT_ACTION_CERTIFICATE_RENEWED = 22;
  AUDIT_ACTION_CERTIFICATE_REVOKED = 23;
  AUDIT_ACTION_CERTIFICATE_DELETED = 24;
  // CA actions
  AUDIT_ACTION_CA_CREATED = 30;
  AUDIT_ACTION_CA_UPDATED = 31;
  AUDIT_ACTION_CA_DELETED = 32;
  AUDIT_ACTION_CA_IMPORTED = 33;
  // API Key actions
  AUDIT_ACTION_API_KEY_CREATED = 40;
  AUDIT_ACTION_API_KEY_REVOKED = 41;
  // Session actions
  AUDIT_ACTION_SESSION_REVOKED = 50;
  AUDIT_ACTION_ALL_SESSIONS_REVOKED = 51;
  // Billing actions
  AUDIT_ACTION_SUBSCRIPTION_CREATED = 60;
  AUDIT_ACTION_SUBSCRIPTION_UPDATED = 61;
  AUDIT_ACTION_SUBSCRIPTION_CANCELED = 62;
  // Settings
  AUDIT_ACTION_SETTINGS_UPDATED = 70;
}

message ListAuditLogsRequest {
  int32 page = 1;
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
  optional AuditAction action = 3;
  optional string user_id = 4;
  optional string resource_type = 5;
  optional string resource_id = 6;
  optional google.protobuf.Timestamp from = 7;
  optional google.protobuf.Timestamp to = 8;
}

message ListAuditLogsResponse {
  repeated AuditLog logs = 1;
  Pagination pagination = 2;
}

message GetAuditLogRequest {
  string log_id = 1 [(buf.validate.field).string.min_len = 1];
}

// =============================================================================
// SESSION SERVICE
// =============================================================================

service SessionService {
  // List active sessions for current user
  rpc ListSessions(ListSessionsRequest) returns (ListSessionsResponse);

  // Get current session details
  rpc GetCurrentSession(google.protobuf.Empty) returns (Session);

  // Revoke a specific session
  rpc RevokeSession(RevokeSessionRequest) returns (google.protobuf.Empty);

  // Revoke all sessions except current
  rpc RevokeAllOtherSessions(google.protobuf.Empty) returns (RevokeAllSessionsResponse);

  // Revoke all sessions (logout everywhere)
  rpc RevokeAllSessions(google.protobuf.Empty) returns (RevokeAllSessionsResponse);
}

message Session {
  option (bufplugins.options.v1.entity) = {
    collection: "sessions"
    id_field: "session_id"
  };

  string session_id = 1;
  string user_id = 2;
  string ip_address = 3;
  string user_agent = 4;
  string device_type = 5;       // "desktop", "mobile", "tablet"
  string browser = 6;           // "Chrome", "Safari", etc.
  string os = 7;                // "macOS", "Windows", etc.
  string location = 8;          // "San Francisco, CA, US" (from IP)
  bool current = 9;             // Is this the current session?
  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp last_active_at = 11;
  google.protobuf.Timestamp expires_at = 12;
}

message ListSessionsRequest {
  int32 page = 1;
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
}

message ListSessionsResponse {
  repeated Session sessions = 1;
  Pagination pagination = 2;
}

message RevokeSessionRequest {
  string session_id = 1 [(buf.validate.field).string.min_len = 1];
}

message RevokeAllSessionsResponse {
  int32 revoked_count = 1;
}

// =============================================================================
// API KEY SERVICE
// =============================================================================

service APIKeyService {
  // Create new API key
  rpc CreateAPIKey(CreateAPIKeyRequest) returns (CreateAPIKeyResponse);

  // List API keys (secrets are masked)
  rpc ListAPIKeys(ListAPIKeysRequest) returns (ListAPIKeysResponse);

  // Get API key details (secret masked)
  rpc GetAPIKey(GetAPIKeyRequest) returns (APIKey);

  // Update API key (name, scopes, expiry)
  rpc UpdateAPIKey(UpdateAPIKeyRequest) returns (APIKey);

  // Revoke API key
  rpc RevokeAPIKey(RevokeAPIKeyRequest) returns (google.protobuf.Empty);
}

message APIKey {
  option (bufplugins.options.v1.entity) = {
    collection: "api_keys"
    id_field: "key_id"
  };

  string key_id = 1;
  string name = 2;
  string key_prefix = 3;        // First 8 chars for identification: "pc_live_abc12345..."
  repeated string scopes = 4;   // ["certificates:read", "certificates:write", "cas:read"]
  APIKeyStatus status = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp last_used_at = 7;
  google.protobuf.Timestamp expires_at = 8;  // Optional expiry
  string created_by = 9;
}

enum APIKeyStatus {
  API_KEY_STATUS_UNSPECIFIED = 0;
  API_KEY_STATUS_ACTIVE = 1;
  API_KEY_STATUS_REVOKED = 2;
  API_KEY_STATUS_EXPIRED = 3;
}

message CreateAPIKeyRequest {
  string name = 1 [(buf.validate.field).string = {min_len: 1, max_len: 100}];
  repeated string scopes = 2 [(buf.validate.field).repeated = {min_items: 1, max_items: 20}];
  optional int32 expires_in_days = 3 [(buf.validate.field).int32 = {gte: 1, lte: 365}];  // 0 = never
}

message CreateAPIKeyResponse {
  APIKey api_key = 1;
  string secret = 2;  // Full secret - only shown once!
}

message ListAPIKeysRequest {
  int32 page = 1;
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
  optional APIKeyStatus status = 3;
}

message ListAPIKeysResponse {
  repeated APIKey api_keys = 1;
  Pagination pagination = 2;
}

message GetAPIKeyRequest {
  string key_id = 1 [(buf.validate.field).string.min_len = 1];
}

message UpdateAPIKeyRequest {
  string key_id = 1 [(buf.validate.field).string.min_len = 1];
  optional string name = 2 [(buf.validate.field).string.max_len = 100];
  repeated string scopes = 3;
}

message RevokeAPIKeyRequest {
  string key_id = 1 [(buf.validate.field).string.min_len = 1];
}

// =============================================================================
// BILLING SERVICE (Stripe Integration)
// =============================================================================

service BillingService {
  // Get current subscription
  rpc GetSubscription(google.protobuf.Empty) returns (Subscription);

  // Get available plans
  rpc ListPlans(google.protobuf.Empty) returns (ListPlansResponse);

  // Create checkout session (redirect to Stripe)
  rpc CreateCheckoutSession(CreateCheckoutSessionRequest) returns (CheckoutSession);

  // Get billing portal URL (Stripe customer portal)
  rpc GetBillingPortalUrl(google.protobuf.Empty) returns (BillingPortalUrl);

  // Get current usage
  rpc GetUsage(google.protobuf.Empty) returns (Usage);

  // List invoices
  rpc ListInvoices(ListInvoicesRequest) returns (ListInvoicesResponse);

  // Get invoice
  rpc GetInvoice(GetInvoiceRequest) returns (Invoice);
}

message Subscription {
  option (bufplugins.options.v1.entity) = {
    collection: "subscriptions"
    id_field: "subscription_id"
  };

  string subscription_id = 1;
  string plan_id = 2;
  string plan_name = 3;
  SubscriptionStatus status = 4;
  google.protobuf.Timestamp current_period_start = 5;
  google.protobuf.Timestamp current_period_end = 6;
  bool cancel_at_period_end = 7;
  google.protobuf.Timestamp canceled_at = 8;
  google.protobuf.Timestamp trial_end = 9;
  PlanLimits limits = 10;
}

enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  SUBSCRIPTION_STATUS_TRIALING = 1;
  SUBSCRIPTION_STATUS_ACTIVE = 2;
  SUBSCRIPTION_STATUS_PAST_DUE = 3;
  SUBSCRIPTION_STATUS_CANCELED = 4;
  SUBSCRIPTION_STATUS_UNPAID = 5;
  SUBSCRIPTION_STATUS_INCOMPLETE = 6;
}

message Plan {
  option (bufplugins.options.v1.entity) = {
    collection: "plans"
    id_field: "plan_id"
  };

  string plan_id = 1;
  string name = 2;               // "Starter", "Pro", "Enterprise"
  string description = 3;
  int64 price_cents = 4;         // Price in cents (e.g., 2999 = $29.99)
  string currency = 5;           // "usd"
  BillingInterval interval = 6;
  PlanLimits limits = 7;
  repeated string features = 8;  // Feature list for display
  bool popular = 9;              // Highlight this plan
}

enum BillingInterval {
  BILLING_INTERVAL_UNSPECIFIED = 0;
  BILLING_INTERVAL_MONTHLY = 1;
  BILLING_INTERVAL_YEARLY = 2;
}

message PlanLimits {
  int32 max_certificates = 1;
  int32 max_cas = 2;
  int32 max_users = 3;
  int32 max_api_keys = 4;
  bool custom_domains = 5;
  bool audit_log_retention_days = 6;
  bool sso_enabled = 7;
  bool priority_support = 8;
}

message ListPlansResponse {
  repeated Plan plans = 1;
}

message CreateCheckoutSessionRequest {
  string plan_id = 1 [(buf.validate.field).string.min_len = 1];
  string success_url = 2 [(buf.validate.field).string.uri = true];
  string cancel_url = 3 [(buf.validate.field).string.uri = true];
}

message CheckoutSession {
  string session_id = 1;
  string url = 2;  // Redirect user here
}

message BillingPortalUrl {
  string url = 1;
}

message Usage {
  int32 certificates_count = 1;
  int32 certificates_limit = 2;
  int32 cas_count = 3;
  int32 cas_limit = 4;
  int32 users_count = 5;
  int32 users_limit = 6;
  int32 api_keys_count = 7;
  int32 api_keys_limit = 8;
  google.protobuf.Timestamp period_start = 9;
  google.protobuf.Timestamp period_end = 10;
}

message Invoice {
  option (bufplugins.options.v1.entity) = {
    collection: "invoices"
    id_field: "invoice_id"
  };

  string invoice_id = 1;
  string invoice_number = 2;
  InvoiceStatus status = 3;
  int64 amount_cents = 4;
  string currency = 5;
  google.protobuf.Timestamp created_at = 6;
  google.protobuf.Timestamp due_date = 7;
  google.protobuf.Timestamp paid_at = 8;
  string pdf_url = 9;
  string hosted_invoice_url = 10;  // Stripe hosted page
}

enum InvoiceStatus {
  INVOICE_STATUS_UNSPECIFIED = 0;
  INVOICE_STATUS_DRAFT = 1;
  INVOICE_STATUS_OPEN = 2;
  INVOICE_STATUS_PAID = 3;
  INVOICE_STATUS_VOID = 4;
  INVOICE_STATUS_UNCOLLECTIBLE = 5;
}

message ListInvoicesRequest {
  int32 page = 1;
  int32 limit = 2 [(buf.validate.field).int32 = {gte: 1, lte: 100}];
}

message ListInvoicesResponse {
  repeated Invoice invoices = 1;
  Pagination pagination = 2;
}

message GetInvoiceRequest {
  string invoice_id = 1 [(buf.validate.field).string.min_len = 1];
}

// =============================================================================
// HEALTH SERVICE
// =============================================================================

service HealthService {
  rpc Check(HealthCheckRequest) returns (HealthCheckResponse);
  rpc Ready(ReadinessCheckRequest) returns (ReadinessCheckResponse);
}

message HealthCheckRequest {}

message HealthCheckResponse {
  string status = 1;
  string version = 2;
  google.protobuf.Timestamp timestamp = 3;
}

message ReadinessCheckRequest {}

message ReadinessCheckResponse {
  bool ready = 1;
  map<string, ComponentHealth> components = 2;
}

message ComponentHealth {
  bool healthy = 1;
  string message = 2;
  int64 latency_ms = 3;
}
